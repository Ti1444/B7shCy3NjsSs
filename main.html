<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StarClash</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* ... (–≤—Å–µ —Å—Ç–∏–ª–∏ –æ—Å—Ç–∞—é—Ç—Å—è —Ç–∞–∫–∏–º–∏ –∂–µ) ... */
    </style>
</head>
<body>
    <!-- ... (HTML —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Å—Ç–∞–µ—Ç—Å—è —Ç–∞–∫–æ–π –∂–µ) ... -->

    <script>
        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è API
        const API_BASE_URL = 'http://localhost:5000/api'; // –î–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
        // const API_BASE_URL = 'https://—Ç–≤–æ–π-—Å–µ—Ä–≤–µ—Ä.com/api'; // –î–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞

        // –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        let userData = {
            balance: 0.00,
            stars: 0,
            level: 1
        };

        let currentPage = 'pvp';

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ API
        async function loadUserData() {
            try {
                console.log('üîÑ –ó–∞–≥—Ä—É–∂–∞—é –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ API...');
                
                const tgUser = Telegram.WebApp.initDataUnsafe.user;
                if (!tgUser || !tgUser.id) {
                    console.log('‚ùå Telegram –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω');
                    return;
                }

                const response = await fetch(`${API_BASE_URL}/user/${tgUser.id}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                
                if (result.success) {
                    const user = result.data;
                    userData = {
                        balance: user.BAL || 0.00,
                        stars: user.ST || 0,
                        level: user.LEVEL || 1
                    };
                    console.log('‚úÖ –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∑–∞–≥—Ä—É–∂–µ–Ω—ã:', userData);
                } else {
                    console.log('‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö');
                }
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', error);
                // –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ–º–æ-–¥–∞–Ω–Ω—ã–µ
                userData = {
                    balance: 1.3,
                    stars: 42,
                    level: 3
                };
                console.log('‚ö†Ô∏è –ò—Å–ø–æ–ª—å–∑—É—é –¥–µ–º–æ-–¥–∞–Ω–Ω—ã–µ:', userData);
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞ —á–µ—Ä–µ–∑ API
        async function updateBalanceAPI(amount) {
            try {
                const tgUser = Telegram.WebApp.initDataUnsafe.user;
                if (!tgUser || !tgUser.id) return false;

                const response = await fetch(`${API_BASE_URL}/update_balance`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        telegram_id: tgUser.id,
                        amount: amount
                    })
                });

                const result = await response.json();
                return result.success;
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞:', error);
                return false;
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∑–≤–µ–∑–¥ —á–µ—Ä–µ–∑ API
        async function updateStarsAPI(stars) {
            try {
                const tgUser = Telegram.WebApp.initDataUnsafe.user;
                if (!tgUser || !tgUser.id) return false;

                const response = await fetch(`${API_BASE_URL}/update_stars`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        telegram_id: tgUser.id,
                        stars: stars
                    })
                });

                const result = await response.json();
                return result.success;
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∑–≤–µ–∑–¥:', error);
                return false;
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞ TON
        function formatBalance(amount) {
            if (amount === 0) return '0.00';
            if (amount >= 1000) {
                return amount.toLocaleString('en-US', {
                    minimumFractionDigits: 1,
                    maximumFractionDigits: 1
                });
            }
            return amount.toFixed(2);
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞
        function updateBalances() {
            document.getElementById('tonBalance').textContent = formatBalance(userData.balance);
            document.getElementById('starsBalance').textContent = Math.floor(userData.stars);
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞/—Å–∫—Ä—ã—Ç–∏—è –≤–∞–ª—é—Ç
        function updateCurrencyDisplay() {
            const tonElement = document.getElementById('tonBalanceElement');
            const starsElement = document.getElementById('starsBalanceElement');

            tonElement.classList.remove('show');
            starsElement.classList.remove('show');

            switch(currentPage) {
                case 'pvp':
                case 'games':
                    tonElement.classList.add('show');
                    break;
                case 'stars':
                case 'mission':
                    starsElement.classList.add('show');
                    break;
                case 'profile':
                    break;
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü
        function showPage(page) {
            currentPage = page;
            document.querySelectorAll('.nav-button').forEach(btn => {
                btn.classList.remove('active');
            });
            event.currentTarget.classList.add('active');
            updateCurrencyDisplay();
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞ –≤ –∏–≥—Ä–µ
        async function updateGameBalance(winAmount) {
            console.log('üé∞ –í—ã–∏–≥—Ä—ã—à –≤ –∏–≥—Ä–µ:', winAmount.toFixed(2), 'TON');
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ
            userData.balance += winAmount;
            updateBalances();
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä
            const success = await updateBalanceAPI(winAmount);
            if (success) {
                console.log('‚úÖ –ë–∞–ª–∞–Ω—Å –æ–±–Ω–æ–≤–ª–µ–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ');
            } else {
                console.log('‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –±–∞–ª–∞–Ω—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ');
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∑–≤–µ–∑–¥ –≤ –∏–≥—Ä–µ
        async function updateGameStars(stars) {
            console.log('‚≠ê –ü–æ–ª—É—á–µ–Ω–æ –∑–≤–µ–∑–¥:', stars);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ
            userData.stars += stars;
            updateBalances();
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä
            const success = await updateStarsAPI(stars);
            if (success) {
                console.log('‚úÖ –ó–≤–µ–∑–¥—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ');
            } else {
                console.log('‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –∑–≤–µ–∑–¥—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ');
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        async function init() {
            Telegram.WebApp.ready();
            Telegram.WebApp.expand();
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            await loadUserData();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            updateBalances();
            updateCurrencyDisplay();
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–º—É
            const themeParams = Telegram.WebApp.themeParams;
            document.body.style.backgroundColor = themeParams.bg_color || '#000000';
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
